<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chicken Cam</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const ChickenCam = () => {
            const [isAudioDetected, setIsAudioDetected] = React.useState(false);
            const [isSetupComplete, setIsSetupComplete] = React.useState(false);
            const [error, setError] = React.useState(null);
            const audioContextRef = React.useRef(null);
            const analyserRef = React.useRef(null);
            const mediaStreamRef = React.useRef(null);

            // Create SVG chicken as default image
            const chickenSvg = `
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="30" fill="#f4c430"/>
                    <circle cx="40" cy="40" r="5" fill="black"/>
                    <path d="M 60 45 Q 65 40 70 45" stroke="red" fill="none" stroke-width="3"/>
                </svg>
            `;
            const chickenDataUrl = `data:image/svg+xml;base64,${btoa(chickenSvg)}`;

            React.useEffect(() => {
                const setupAudio = async () => {
                    try {
                        console.log('Requesting microphone access...');
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        console.log('Microphone access granted');
                        mediaStreamRef.current = stream;

                        audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
                        const source = audioContextRef.current.createMediaStreamSource(stream);
                        analyserRef.current = audioContextRef.current.createAnalyser();
                        analyserRef.current.fftSize = 256;
                        source.connect(analyserRef.current);

                        const dataArray = new Uint8Array(analyserRef.current.frequencyBinCount);
                        const checkAudio = () => {
                            analyserRef.current.getByteFrequencyData(dataArray);
                            const audioLevel = dataArray.reduce((a, b) => a + b) / dataArray.length;
                            setIsAudioDetected(audioLevel > 30);
                            requestAnimationFrame(checkAudio);
                        };
                        checkAudio();
                        setIsSetupComplete(true);
                        setError(null);
                    } catch (error) {
                        console.error('Audio setup error:', error);
                        setError(error.message);
                    }
                };

                setupAudio();

                return () => {
                    if (mediaStreamRef.current) {
                        mediaStreamRef.current.getTracks().forEach(track => track.stop());
                    }
                    if (audioContextRef.current) {
                        audioContextRef.current.close();
                    }
                };
            }, []);

            return (
                <div className="relative w-full max-w-lg mx-auto p-4">
                    <div className="relative aspect-video bg-white rounded-lg overflow-hidden shadow-lg">
                        <img
                            src={chickenDataUrl}
                            alt="Chicken avatar"
                            className={`w-full h-full object-contain transition-transform duration-200 ${
                                isAudioDetected ? 'scale-110' : 'scale-100'
                            }`}
                        />
                        
                        {!isSetupComplete && !error && (
                            <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white">
                                <p>Setting up audio detection...</p>
                            </div>
                        )}

                        {error && (
                            <div className="absolute inset-0 flex items-center justify-center bg-red-500 bg-opacity-50 text-white p-4 text-center">
                                <div>
                                    <p className="font-bold mb-2">Error:</p>
                                    <p>{error}</p>
                                    <p className="mt-2 text-sm">Make sure you've allowed microphone access</p>
                                </div>
                            </div>
                        )}

                        <div className={`absolute bottom-4 right-4 w-4 h-4 rounded-full transition-colors duration-200 ${
                            isAudioDetected ? 'bg-green-500' : 'bg-red-500'
                        }`} />
                    </div>

                    <div className="mt-4 bg-white rounded-lg p-4 shadow-lg">
                        <h3 className="font-bold mb-2">Status:</h3>
                        <p>Setup Complete: {isSetupComplete ? '✅' : '❌'}</p>
                        <p>Audio Detected: {isAudioDetected ? '✅' : '❌'}</p>
                        {error && <p className="text-red-500">Error: {error}</p>}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<ChickenCam />, document.getElementById('root'));
    </script>
</body>
</html>
